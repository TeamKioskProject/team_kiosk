name: Flutter Test

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - '**'

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1. ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Flutter ì„¤ì¹˜
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.29.2"

      # 3. íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install Dependencies
        run: flutter pub get

      # 4. ImageMagick ì„¤ì¹˜ (ê³¨ë“  íŒŒì¼ ìƒì„±ì— í•„ìš”)
      - name: Install ImageMagick (Required for Golden File Creation)
        run: sudo apt-get install -y imagemagick

      # 5. ìœ„ì ¯ í…ŒìŠ¤íŠ¸ íŒŒì¼ ë° ê³¨ë“  íŒŒì¼ ìƒì„±
      - name: Find or Create Widget and Golden Test Files
        id: find_or_create_tests
        run: |
          echo "ðŸ” Finding changed widget files..."
          mkdir -p .tmp
          
          # ê¸°ë³¸ ë¸Œëžœì¹˜ê°€ ë¹„ì–´ìžˆëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì•ˆì „í•œ git diff
          git fetch origin
          BASE_REF=${{ github.base_ref || 'main' }}
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ë¹ˆ íŒŒì¼ ìƒì„±
          git diff --name-only origin/$BASE_REF..HEAD > .tmp/changed_widgets_raw.txt || true
          
          
          
          # ìœ„ì ¯ íŒŒì¼ í•„í„°ë§
          grep -E "lib/.*\.dart" .tmp/changed_widgets_raw.txt | grep -v "_test.dart" > .tmp/changed_widgets.txt

          # í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ë£¨í”„
          while IFS= read -r widget_file; do
            # í…ŒìŠ¤íŠ¸ íŒŒì¼ ê²½ë¡œ ì„¤ì •
            test_file="${widget_file/lib/test}"
            test_file="${test_file/.dart/_test.dart}"
            golden_dir="${test_file/test/goldens}"
            
            # ìœ„ì ¯ ì´ë¦„ ì¶”ì¶œ
            widget_name=$(basename "$widget_file" .dart)

            # í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
            if [ ! -f "$test_file" ]; then
              echo "ðŸ“ Creating test file for $widget_file -> $test_file"
              mkdir -p "$(dirname "$test_file")"
              cat <<EOF > "$test_file"
                import 'dart:io';
                import 'package:flutter_test/flutter_test.dart';
                import 'package:flutter/material.dart';
                import 'package:team_kiosk/main.dart';
                import 'package:team_kiosk/${widget_file#lib/}';

                void main() {
                  setUpAll(() {
                    // Mock ë„¤íŠ¸ì›Œí¬ ì´ë¯¸ì§€
                    httpOverrides();
                  });
                
                  testWidgets('${widget_name} ì ‘ê·¼ì„± ë° ë©€í‹° í•´ìƒë„ ê³¨ë“  í…ŒìŠ¤íŠ¸', (WidgetTester tester) async {
                    await tester.pumpWidget(MyApp());
                    
                    // ìœ„ì ¯ ë¡œë“œ í…ŒìŠ¤íŠ¸
                    expect(find.byType(${widget_name}), findsOneWidget);
                    
                    // ìŠ¤í¬ë¦° ë¦¬ë” ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
                    final semantics = tester.getSemantics(find.byType(${widget_name}));
                    expect(semantics, isNotNull, reason: 'ìŠ¤í¬ë¦° ë¦¬ë”ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ì—†ëŠ” ìœ„ì ¯ìž…ë‹ˆë‹¤.');
                    
                    // ëª¨ë“  ì¤‘ìš”í•œ ìš”ì†Œê°€ ë ˆì´ë¸”ì„ ê°€ì§€ê³  ìžˆëŠ”ì§€ í™•ì¸
                    semantics.visitChildren((child) {
                      final hasLabel = child.label != null && child.label.isNotEmpty;
                      expect(hasLabel, isTrue, reason: 'ëª¨ë“  ì¤‘ìš”í•œ ìš”ì†ŒëŠ” ìŠ¤í¬ë¦° ë¦¬ë”ë¥¼ ìœ„í•œ ë ˆì´ë¸”ì´ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                      return true;
                    });
                    
                    // ì—¬ëŸ¬ í•´ìƒë„ì—ì„œ í…ŒìŠ¤íŠ¸
                    final resolutions = [
                      Size(300, 600),
                      Size(375, 812),
                      Size(768, 1024),
                      Size(1024, 1366),
                    ];
                    
                    for (final resolution in resolutions) {
                      tester.binding.window.physicalSizeTestValue = resolution;
                      tester.binding.window.devicePixelRatioTestValue = 2.0;
                      await tester.pumpAndSettle();
                      
                      final goldenFile = '${golden_dir}/${widget_name}_${resolution.width.toInt()}x${resolution.height.toInt()}.png';
                      await expectLater(
                        find.byType(${widget_name}),
                        matchesGoldenFile(goldenFile)
                      );
                    }
                
                    // í•´ìƒë„ ì´ˆê¸°í™”
                    tester.binding.window.clearPhysicalSizeTestValue();
                  });
                }
                
                void httpOverrides() {
                  HttpOverrides.global = _MockHttpOverrides();
                }
                
                class _MockHttpOverrides extends HttpOverrides {
                  @override
                  HttpClient createHttpClient(SecurityContext? context) {
                    final httpClient = super.createHttpClient(context);
                    httpClient.findProxy = (uri) => 'DIRECT';
                    httpClient.badCertificateCallback = (cert, host, port) => true;
                    return httpClient;
                  }
                }
                EOF
              git add "$test_file"
            else
              echo "âœ… Test file already exists: $test_file"
            fi
            
            # ê³¨ë“  íŒŒì¼ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p "$golden_dir"
            
            # ê¸°ë³¸ ê³¨ë“  íŒŒì¼ ìƒì„± (ë¹„ì–´ ìžˆëŠ” ì´ë¯¸ì§€)
            for resolution in 300x600 375x812 768x1024 1024x1366; do
              golden_file="${golden_dir}/${widget_name}_${resolution}.png"
              if [ ! -f "$golden_file" ]; then
                echo "ðŸ–¼ï¸ Creating empty golden file for $widget_file -> $golden_file"
                convert -size ${resolution} xc:white "$golden_file"
                git add "$golden_file"
              else
                echo "âœ… Golden file already exists: $golden_file"
              fi
            done
          done < .tmp/changed_widgets.txt

      # 6. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run Accessibility and Golden Tests
        if: steps.find_or_create_tests.outcome == 'success'
        run: |
          echo "ðŸ§ª Running accessibility and multi-resolution golden tests..."
          find test -name "*_test.dart" | while read -r widget_test_file; do
            echo "ðŸ§ª Testing $widget_test_file..."
            flutter test "$widget_test_file" || exit 1
          done
          echo "ðŸŽ‰ All accessibility and multi-resolution golden tests passed"
          
      # 7. ê³¨ë“  íŒŒì¼ ì—…ë¡œë“œ
      - name: Upload Golden Files
        if: steps.find_or_create_tests.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: golden-files
          path: goldens/
